# Бэктест: Проверка конвергенции топ-трейдеров на исторических данных

## Цель

Проверить, работает ли конвергенция топ-трейдеров Polymarket как предиктор исхода рынка.
Ключевые вопросы:
- Tier 1 (3+ трейдеров) точнее Tier 2 (2 трейдера)?
- Какой тир даёт лучший P&L?
- Работает ли category_match как фильтр?
- Какой оптимальный Kelly fraction по тирам?

## Как запустить

```bash
cd /root/poly-smart-radar
source venv/bin/activate

# Полный бэктест за 3 месяца
python scripts/backtest.py --months 3

# Только за 1 месяц (быстрее)
python scripts/backtest.py --months 1

# С сохранением в файл
python scripts/backtest.py --months 3 --output results.json

# Отчёт из сохранённого файла
python scripts/backtest_report.py results.json
```

## Алгоритм

### Фаза 1: Сбор данных
1. Загружает вотчлист трейдеров из БД (`traders` таблица)
2. Для каждого трейдера запрашивает закрытые позиции через Data API
3. Загружает все резолвнутые рынки за период через Gamma API

### Фаза 2: Реконструкция сигналов
Для каждого резолвнутого рынка:
1. Находит всех трейдеров из вотчлиста, у которых была позиция
2. Группирует по направлению (YES/NO)
3. Если 2+ трейдера зашли в одном направлении — генерирует "виртуальный сигнал"
4. Рассчитывает signal_score и tier по тем же формулам, что и live-система

### Фаза 3: Расчёт P&L
- entry_price = средняя цена входа трейдеров
- Если direction совпал с resolution → P&L = (1 - entry_price) / entry_price
- Если не совпал → P&L = -100%

### Фаза 4: Аналитика
- Win rate и средний P&L по тирам
- Разбивка по категориям (Crypto, Sports, Politics...)
- Kelly fraction по тирам
- Сравнение high conviction vs low conviction

## Интерпретация результатов

| Метрика | Хорошо | Плохо |
|---------|--------|-------|
| Win Rate Tier 1 | > 60% | < 50% |
| Win Rate Tier 2 | > 55% | < 45% |
| Avg P&L Tier 1 | > +20% | < 0% |
| Kelly > 0 | Стратегия прибыльна | Стратегия убыточна |

### Kelly Criterion
```
kelly = (win_rate * avg_win_pnl - (1 - win_rate)) / avg_win_pnl
```
Если kelly > 0 — стратегия прибыльна в долгосроке.
Рекомендуется использовать Half-Kelly (kelly / 2) для безопасности.

## Ограничения

- **Нет точных таймстемпов входа**: закрытые позиции не содержат дату открытия,
  поэтому freshness = 1.0 для всех сигналов (консервативная оценка)
- **Survivorship bias**: в вотчлисте только текущие топ-трейдеры,
  возможно они были менее успешны 3 месяца назад
- **Слиппедж не учитывается**: реальная цена входа может отличаться
- **Исторические цены**: для резолвнутых рынков доступны только 12-часовые свечи

## Ресурсы

- API запросов: ~1100 (2-3 минуты)
- Диск: < 150 МБ
- RAM: ~200 МБ пиковое
- Общее время: 5-7 минут
